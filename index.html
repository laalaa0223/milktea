<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ÊâãÊêñÂ§ß‰ΩúÊà∞ ‚ú®</title>
    <!-- ËºâÂÖ•Ê†∏ÂøÉÂ•ó‰ª∂ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react"></script>
    
    <!-- ËºâÂÖ• Firebase SDK (CDN ÁâàÊú¨) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Â∞á Firebase ÂäüËÉΩÊéõËºâÂà∞ÂÖ®ÂüüÔºåÊñπ‰æø React ‰ΩøÁî®
        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot, collection };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .heart-beat { animation: heartBeat 1.5s ease-in-out infinite; }
        @keyframes heartBeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.1); }
            28% { transform: scale(1); }
            42% { transform: scale(1.1); }
            70% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-[#FFF9FB] text-slate-600">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { Heart, ChevronLeft, ChevronRight, X, Trash2, Store, CupSoda, Loader2 } = lucide;

        // --- üî¥ Firebase ÈÖçÁΩÆÂçÄ üî¥ ---
        // Ë´ãÂ∞á‰∏ãÊñπ empty string ÊõøÊèõÁÇ∫‰Ω†Âú® Firebase ÊéßÂà∂Âè∞ÂæóÂà∞ÁöÑÊ≠£Á¢∫Ë≥áË®ä
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [records, setRecords] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [currentMonth, setCurrentMonth] = useState(new Date(2026, 0, 1));
            const [syncing, setSyncing] = useState(false);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-drink-tracker-2026';
            const iceOptions = ["Ê≠£Â∏∏ÂÜ∞", "Â∞ëÂÜ∞", "ÂæÆÂÜ∞", "ÂéªÂÜ∞", "Â∏∏Ê∫´", "Ê∫´ÁÜ±", "ÁÑ°Ê≥ïË™øÊï¥"];
            const sugarOptions = ["ÂÖ®Á≥ñ", "‰∏ÉÂàÜ", "ÂçäÁ≥ñ", "‰∏âÂàÜ", "‰∏ÄÂàÜ", "ÁÑ°Á≥ñ", "ÁÑ°Ê≥ïË™øÊï¥"];

            // 1. ÂàùÂßãÂåñ Firebase Ëàá ÂåøÂêçÁôªÂÖ•
            useEffect(() => {
                const init = async () => {
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.FB;
                    const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
                    const app = initializeApp(config);
                    const auth = getAuth(app);
                    const firestore = getFirestore(app);
                    setDb(firestore);

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    onAuthStateChanged(auth, (u) => setUser(u));
                };
                init();
            }, []);

            // 2. Áõ£ËÅΩ Firestore Êï∏Êìö (Âç≥ÊôÇÊõ¥Êñ∞)
            useEffect(() => {
                if (!user || !db) return;
                const { doc, onSnapshot } = window.FB;
                // Ê†πÊìöË∑ØÂæëË¶èÁØÑÔºö/artifacts/{appId}/users/{userId}/data/main
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'main');
                
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setRecords(docSnap.data().records || {});
                    }
                }, (error) => console.error("Firestore Listen Error:", error));
                
                return () => unsubscribe();
            }, [user, db]);

            // 3. ÂêåÊ≠•Êï∏ÊìöÂà∞Èõ≤Á´Ø
            const syncData = async (newRecords) => {
                setRecords(newRecords);
                if (!user || !db) return;
                const { doc, setDoc } = window.FB;
                try {
                    setSyncing(true);
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'main');
                    await setDoc(docRef, { records: newRecords }, { merge: true });
                    setTimeout(() => setSyncing(false), 800);
                } catch (e) { 
                    console.error(e);
                    setSyncing(false);
                }
            };

            // 4. Êï∏ÊìöÂàÜÊûêÈÇèËºØ
            const analytics = useMemo(() => {
                const shopMap = {};
                const itemMap = {};
                let mC = 0, yC = 0;
                const targetM = currentMonth.getMonth() + 1;

                Object.entries(records).forEach(([date, list]) => {
                    const [y, m] = date.split('-').map(Number);
                    if (y === 2026) {
                        yC += list.length;
                        if (m === targetM) mC += list.length;
                        list.forEach(i => {
                            if (i.shop) shopMap[i.shop] = (shopMap[i.shop] || 0) + 1;
                            if (i.item) itemMap[i.item] = (itemMap[i.item] || 0) + 1;
                        });
                    }
                });

                const getTop = (map) => {
                    const res = Object.entries(map).sort((a,b) => b[1]-a[1])[0];
                    return res ? res[0] : "Â∞öÁÑ°Á¥ÄÈåÑ";
                };

                return { mC, yC, topShop: getTop(shopMap), topItem: getTop(itemMap) };
            }, [records, currentMonth]);

            const { firstDay, totalDays } = useMemo(() => {
                const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
                return { firstDay: new Date(y, m, 1).getDay(), totalDays: new Date(y, m + 1, 0).getDate() };
            }, [currentMonth]);

            return (
                <div className="max-w-md mx-auto p-4 pb-12">
                    {/* Header */}
                    <header className="relative bg-gradient-to-br from-[#FFD1D1] to-[#D1E1FF] rounded-[2.5rem] shadow-lg p-6 mb-4 text-center text-white border-4 border-white">
                        <h1 className="text-2xl font-black italic tracking-tighter">2026 ÊâãÊêñÂ§ß‰ΩúÊà∞</h1>
                        <p className="text-[10px] font-bold tracking-[0.2em] opacity-80 mt-1 uppercase italic">Personal Drink Diary</p>
                        {syncing && (
                            <div className="absolute top-3 right-5 flex items-center gap-1 bg-white/20 px-2 py-0.5 rounded-full">
                                <Loader2 size={10} className="animate-spin" />
                                <span className="text-[8px] font-bold">SAVING</span>
                            </div>
                        )}
                    </header>

                    {/* ÁΩÆÈ†ÇÂàÜÊûêÊï∏Êìö */}
                    <section className="grid grid-cols-2 gap-3 mb-4">
                        <div className="bg-white p-4 rounded-[2rem] shadow-sm border border-orange-50 flex flex-col items-center text-center">
                            <div className="bg-orange-100 p-2 rounded-full mb-2"><Store size={16} className="text-orange-400" /></div>
                            <h4 className="text-[9px] font-black text-orange-300 uppercase mb-1">ÊúÄÊÑõÂ∫óÂÆ∂</h4>
                            <p className="text-xs font-black text-slate-700 truncate w-full px-2">{analytics.topShop}</p>
                        </div>
                        <div className="bg-white p-4 rounded-[2rem] shadow-sm border border-purple-50 flex flex-col items-center text-center">
                            <div className="bg-purple-100 p-2 rounded-full mb-2"><CupSoda size={16} className="text-purple-400" /></div>
                            <h4 className="text-[9px] font-black text-purple-300 uppercase mb-1">ÊúÄÊÑõÂìÅÈ†Ö</h4>
                            <p className="text-xs font-black text-slate-700 truncate w-full px-2">{analytics.topItem}</p>
                        </div>
                    </section>

                    {/* Êúà/Âπ¥ Ë®àÊï∏ */}
                    <section className="grid grid-cols-2 gap-3 mb-6">
                        <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-pink-50">
                            <h4 className="text-[9px] font-black text-pink-300 uppercase mb-1">{currentMonth.getMonth()+1}ÊúàÊùØÊï∏</h4>
                            <div className="flex items-end gap-1"><span className="text-2xl font-black text-slate-700">{analytics.mC}</span><span className="text-[10px] text-slate-300 mb-1 font-bold">ÊùØ</span></div>
                        </div>
                        <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-blue-50">
                            <h4 className="text-[9px] font-black text-blue-300 uppercase mb-1">2026 Á∏ΩË®à</h4>
                            <div className="flex items-end gap-1"><span className="text-2xl font-black text-slate-700">{analytics.yC}</span><span className="text-[10px] text-slate-300 mb-1 font-bold">ÊùØ</span></div>
                        </div>
                    </section>

                    {/* Êó•ÊõÜÊéßÂà∂ */}
                    <nav className="flex items-center justify-between mb-4 px-2">
                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))} className="p-3 bg-white rounded-2xl shadow-sm text-pink-200 active:scale-90 transition-transform"><ChevronLeft/></button>
                        <h2 className="text-lg font-black tracking-tight">{currentMonth.getFullYear()} . {currentMonth.getMonth() + 1}</h2>
                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))} className="p-3 bg-white rounded-2xl shadow-sm text-pink-200 active:scale-90 transition-transform"><ChevronRight/></button>
                    </nav>

                    {/* Êó•ÊõÜÊú¨È´î - ÊÑõÂøÉÊ®°Âºè */}
                    <main className="bg-white rounded-[2.5rem] shadow-md p-3 border border-pink-50 mb-6">
                        <div className="grid grid-cols-7 text-center text-[10px] font-black text-pink-200 py-2">
                            {['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d => <div key={d}>{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-1">
                            {Array.from({ length: firstDay }).map((_, i) => <div key={`e-${i}`} className="h-14"></div>)}
                            {Array.from({ length: totalDays }).map((_, i) => {
                                const d = i + 1;
                                const key = `2026-${currentMonth.getMonth()+1}-${d}`;
                                const dayRecords = records[key] || [];
                                const hasData = dayRecords.length > 0;
                                return (
                                    <div 
                                        key={d} 
                                        onClick={() => { setSelectedDate(key); setIsModalOpen(true); }} 
                                        className={`h-14 rounded-2xl flex flex-col items-center justify-start pt-2 cursor-pointer active:scale-95 transition-all ${hasData ? 'bg-pink-50/50 border border-pink-100' : 'bg-slate-50/10'}`}
                                    >
                                        <span className={`text-[10px] font-black mb-1 ${hasData ? 'text-pink-400' : 'text-slate-300'}`}>{d}</span>
                                        <div className="flex flex-wrap justify-center gap-0.5 px-0.5">
                                            {dayRecords.map((_, idx) => <Heart key={idx} size={7} className="text-pink-400 fill-pink-400 heart-beat" />)}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {/* Á¥ÄÈåÑÂΩàÁ™ó (Modal) */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/40 backdrop-blur-sm p-4">
                            <div className="bg-white w-full max-w-md rounded-[3rem] max-h-[85vh] flex flex-col shadow-2xl overflow-hidden animate-in slide-in-from-bottom duration-300">
                                <div className="p-6 border-b border-pink-50 flex justify-between items-center bg-white">
                                    <div className="flex items-center gap-2">
                                        <Heart size={18} className="text-pink-400 fill-pink-400" />
                                        <h3 className="font-black text-slate-700 tracking-tight">{selectedDate} È£≤ÂìÅÁ¥ÄÈåÑ</h3>
                                    </div>
                                    <button onClick={() => setIsModalOpen(false)} className="p-2 text-slate-400 bg-slate-100 rounded-full hover:rotate-90 transition-transform"><X/></button>
                                </div>

                                <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/30">
                                    {(records[selectedDate] || []).map((drink) => (
                                        <div key={drink.id} className="p-5 bg-white rounded-[2rem] border border-pink-50 relative space-y-4 shadow-sm">
                                            <button 
                                                onClick={() => {
                                                    const newList = records[selectedDate].filter(i => i.id !== drink.id);
                                                    syncData({ ...records, [selectedDate]: newList });
                                                }} 
                                                className="absolute top-4 right-6 text-slate-200 hover:text-red-300 transition-colors"
                                            >
                                                <Trash2 size={16}/>
                                            </button>
                                            
                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="space-y-1">
                                                    <label className="text-[9px] font-black text-slate-300 ml-1 uppercase">Shop Â∫óÂÆ∂</label>
                                                    <input placeholder="‰æãÂ¶ÇÔºö50Âµê" value={drink.shop} onChange={(e) => {
                                                        const newList = records[selectedDate].map(i => i.id === drink.id ? {...i, shop: e.target.value} : i);
                                                        syncData({...records, [selectedDate]: newList});
                                                    }} className="w-full bg-slate-50 p-2.5 rounded-xl border-none text-xs font-bold focus:ring-1 focus:ring-pink-200" />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[9px] font-black text-slate-300 ml-1 uppercase">Item ÂìÅÈ†Ö</label>
                                                    <input placeholder="‰æãÂ¶ÇÔºöÂõõÂ≠£Êò•" value={drink.item} onChange={(e) => {
                                                        const newList = records[selectedDate].map(i => i.id === drink.id ? {...i, item: e.target.value} : i);
                                                        syncData({...records, [selectedDate]: newList});
                                                    }} className="w-full bg-slate-50 p-2.5 rounded-xl border-none text-xs font-bold focus:ring-1 focus:ring-pink-200" />
                                                </div>
                                            </div>

                                            <div className="space-y-1">
                                                <label className="text-[9px] font-black text-slate-300 ml-1 uppercase">Ice Level ÂÜ∞Â°ä</label>
                                                <div className="flex flex-wrap gap-1.5">
                                                    {iceOptions.map(opt => (
                                                        <button 
                                                            key={opt} 
                                                            onClick={() => {
                                                                const newList = records[selectedDate].map(i => i.id === drink.id ? {...i, ice: opt} : i);
                                                                syncData({...records, [selectedDate]: newList});
                                                            }} 
                                                            className={`px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all ${drink.ice === opt ? 'bg-pink-400 text-white border-pink-400' : 'bg-white text-slate-400 border-slate-100 shadow-sm'} ${opt === "ÁÑ°Ê≥ïË™øÊï¥" ? 'border-dashed' : ''}`}
                                                        >
                                                            {opt}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="space-y-1">
                                                <label className="text-[9px] font-black text-slate-300 ml-1 uppercase">Sugar Level ÁîúÂ∫¶</label>
                                                <div className="flex flex-wrap gap-1.5">
                                                    {sugarOptions.map(opt => (
                                                        <button 
                                                            key={opt} 
                                                            onClick={() => {
                                                                const newList = records[selectedDate].map(i => i.id === drink.id ? {...i, sugar: opt} : i);
                                                                syncData({...records, [selectedDate]: newList});
                                                            }} 
                                                            className={`px-3 py-1.5 rounded-full text-[10px] font-bold border transition-all ${drink.sugar === opt ? 'bg-blue-400 text-white border-blue-400' : 'bg-white text-slate-400 border-slate-100 shadow-sm'} ${opt === "ÁÑ°Ê≥ïË™øÊï¥" ? 'border-dashed' : ''}`}
                                                        >
                                                            {opt}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="space-y-1">
                                                <label className="text-[9px] font-black text-slate-300 ml-1 uppercase">Price ÂÉπÊ†º</label>
                                                <div className="relative">
                                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-300 font-bold">$</span>
                                                    <input type="number" placeholder="0" value={drink.price} onChange={(e) => {
                                                        const newList = records[selectedDate].map(i => i.id === drink.id ? {...i, price: e.target.value} : i);
                                                        syncData({...records, [selectedDate]: newList});
                                                    }} className="w-full bg-slate-50 p-2.5 pl-7 rounded-xl border-none text-xs font-bold focus:ring-1 focus:ring-pink-200" />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    
                                    <button 
                                        onClick={() => {
                                            const newList = [...(records[selectedDate] || []), { id: Date.now(), shop: '', item: '', price: '', ice: 'ÂæÆÂÜ∞', sugar: '‰∏âÂàÜ' }];
                                            syncData({ ...records, [selectedDate]: newList });
                                        }} 
                                        className="w-full py-5 border-2 border-dashed border-pink-100 rounded-[2rem] text-pink-200 text-[10px] font-black uppercase tracking-widest bg-white hover:bg-pink-50/30 transition-colors"
                                    >
                                        + Add New Record
                                    </button>
                                </div>
                                
                                <div className="p-6 bg-white border-t border-pink-50">
                                    <button onClick={() => setIsModalOpen(false)} className="w-full bg-pink-400 text-white font-black py-4 rounded-[2rem] shadow-lg active:scale-95 transition-all text-sm uppercase tracking-widest">Close & Saved</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="mt-8 text-center opacity-20">
                        <p className="text-[7px] font-black uppercase tracking-[0.6em]">2026 Beverage Analytics ‚Ä¢ Heart Edition</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
